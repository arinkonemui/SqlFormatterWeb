<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL整形ツール（高速・無料・ブラウザだけ）</title>
  <meta name="description" content="SQLをブラウザだけでサッと整形・作成。MySQL/PostgreSQL/SQLite/SQL Server対応。データ送信なし＆完全無料。" />
  <style>
    :root { --bg:#111827; --card:#1a2335; --muted:#94a3b8; --fg:#e5e7eb; --acc:#22d3ee; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .title{font-size:24px;font-weight:800;letter-spacing:.5px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgb(0 0 0 / .25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > *{margin:4px 0}
    select, input[type="number"], input[type="checkbox"], input[type="text"]{background:#0b1220;border:1px solid #243045;color:var(--fg);border-radius:10px;padding:8px 10px}
    input[type="text"]{min-width:180px}
    textarea{width:100%;min-height:180px;background:#0b1220;border:1px solid #243045;border-radius:12px;color:var(--fg);padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .out{min-height:220px;white-space:pre;overflow:auto}
    .btn{background:#0b1220;border:1px solid #334155;color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#475569}
    .btn.primary{border-color:#0ea5b7;background:linear-gradient(180deg,#0ea5b7,#0b7782);font-weight:700}
    .btn.small{padding:6px 10px;border-radius:8px}
    .muted{color:var(--muted);font-size:13px}
    .footer{margin-top:18px;color:#9ca3af;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#cbd5e1}
    .hint{font-size:12px;color:#a1a1aa}
    .danger{border-color:#ef4444 !important;color:#fecaca !important}
    .vstack{display:flex;flex-direction:column;gap:10px}
    /* タブ用（アクティブ強調） */
    .btn.tab{border-radius:9999px}
    .btn.tab.active{background:#2563eb;border-color:#2563eb;color:#fff;font-weight:700}
    /* フッターを他カードと同じトーン＆幅に */
    footer.site-footer.card { /* .card を併用して見た目を統一 */
      padding: 10px 12px;
    }
    footer.site-footer .footer-nav{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:18px;                 /* 3リンクの間隔 */
    }
    footer.site-footer .footer-nav a{
      color: var(--fg);         /* 青リンクより視認性を上げる */
      text-decoration: underline;
    }
    footer.site-footer .footer-nav .sep{
      opacity:.45;              /* 区切りスラッシュは控えめに */
    }
  </style>
  <!-- sql-formatter（UMD） -->
  <script src="https://unpkg.com/sql-formatter/dist/sql-formatter.min.js"></script>

  <!-- AdSense site verification / Auto ads -->
    <meta name="google-adsense-account" content="ca-pub-XXXXXXXXXXXXXXX">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="title">SQL整形ツール</div>
      <div class="badge">ローカル実行 / データ送信なし</div>
    </div>
    <!-- ツール概要（申請前チェック用の簡易説明） -->
    <div class="card" style="margin-top:10px">
      <div class="muted">このサイトについて</div>
      <div style="margin-top:6px">
        <p style="margin:0 0 6px">
          本ツールは、ブラウザ内のみで SQL を整形・作成する無料サービスです。入力内容はサーバへ送信しません。
        </p>
        <p style="margin:0 0 6px">
          対応方言：MySQL / PostgreSQL / SQLite / SQL Server (T-SQL)
        </p>
        <p class="hint" style="margin:0">
          免責：生成・整形結果の正確性は保証しません。ご利用前に内容をご確認ください。
        </p>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <!-- ツールバー -->
      <div class="row">
        <label>方言
          <select id="dialect">
            <option value="sql">Standard SQL</option>
            <option value="mysql">MySQL</option>
            <option value="postgresql">PostgreSQL</option>
            <option value="sqlite">SQLite</option>
            <option value="tsql">SQL Server (T-SQL)</option>
          </select>
        </label>
        <label>インデント
          <input id="indent" type="number" min="2" max="8" step="1" value="2" />
        </label>
        <label><input id="uppercase" type="checkbox" /> キーワードを大文字に</label>

        <button class="btn primary" id="formatBtn">整形</button>
        <button class="btn" id="minifyBtn">ミニファイ</button>
        <button class="btn" id="copyBtn">コピー</button>
        <button class="btn" id="clearBtn">クリア</button>
      </div>

      <!-- 方言ヒント -->
      <div class="muted" style="margin-top:6px">
        ヒント：T-SQL（@変数, TOP）は「SQL Server (T-SQL)」、PostgreSQL（ILIKE, ::cast）は「PostgreSQL」など、方言を切り替えると整形しやすくなります。
      </div>

      <!-- タブ切替 -->
      <div class="row" style="margin-top:8px">
        <button class="btn tab active" id="tabFormat">整形ツール</button>
        <button class="btn tab" id="tabBuilder">SQL作成</button>
      </div>

      <!-- ===== SQLビルダー：オペレーション対応 ===== -->
      <div id="builder" class="card" style="margin-top:12px; display:none">
        <!-- 操作選択 -->
        <div class="row">
          <label>操作
            <select id="op">
              <option value="select">SELECT</option>
              <option value="insert">INSERT</option>
              <option value="update">UPDATE</option>
              <option value="create">CREATE TABLE</option>
            </select>
          </label>
        </div>

        <!-- 共通：テーブル名 -->
        <div class="row" id="row_table">
          <label>テーブル名 <input id="b_table" type="text" placeholder="テーブル名" /></label>
        </div>

        <!-- --- SELECT 専用エリア --- -->
        <div id="area_select" class="vstack" style="margin-top:6px">
          <!-- カラム -->
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">カラム（複数可）</div>
              <div class="hint">空欄は無視</div>
            </div>
            <div id="colsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addCol">＋ カラムを追加</button>
            </div>
          </div>

          <!-- JOIN -->
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">JOIN（複数可）</div>
              <div class="hint">ON は「左側」「演算子」「右側」を1行として追加。2行目以降は先頭で AND/OR を選択。</div>
            </div>
            <div id="joinsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addJoin">＋ JOINを追加</button>
            </div>
          </div>

          <!-- 条件 -->
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">条件（WHERE：複数可／AND結合）</div>
              </div>
            <div id="condsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addCond">＋ 条件を追加</button>
              <button class="btn small" id="addCondGroupStart">（ 開始</button>
              <button class="btn small" id="addCondGroupEnd">） 終了</button>
            </div>
          </div>

          <!-- ORDER / LIMIT -->
          <div class="row" style="margin-top:6px">
            <label>並び順（ORDER BY）
              <input id="b_order_field" type="text" placeholder="created_at" />
            </label>
            <label>方向
              <select id="b_order_dir">
                <option value="ASC" selected>ASC</option>
                <option value="DESC">DESC</option>
              </select>
            </label>
            <label>件数（LIMIT）
              <input id="b_limit" type="number" min="1" placeholder="100" style="width:100px"/>
            </label>
          </div>
        </div>

        <!-- --- INSERT 専用エリア --- -->
        <div id="area_insert" class="vstack" style="margin-top:6px; display:none">
          <div class="row" style="justify-content:space-between">
            <div class="muted">列と値（複数可）</div>
          </div>
          <div id="insGrid" class="vstack" style="margin-top:6px"></div>
          <div class="row" style="margin-top:6px">
            <button class="btn small" id="addIns">＋ 列を追加</button>
          </div>
        </div>

        <!-- --- UPDATE 専用エリア --- -->
        <div id="area_update" class="vstack" style="margin-top:6px; display:none">
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">SET（フィールド＝値：複数可）</div>
              <div class="hint">値はクォート等を含めて入力（例：name='Alice', count=count+1）</div>
            </div>
            <div id="setGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addSet">＋ SETを追加</button>
            </div>
          </div>

          <div style="margin-top:8px">
            <div class="row" style="justify-content:space-between">
              <div class="muted">条件（WHERE：複数可／AND結合）</div>
            </div>
            <div id="uCondsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addUCond">＋ 条件を追加</button>
              <button class="btn small" id="addUCondGroupStart">（ 開始</button>
              <button class="btn small" id="addUCondGroupEnd">） 終了</button>
            </div>
          </div>
        </div>

        <!-- --- CREATE TABLE 専用エリア --- -->
        <div id="area_create" class="vstack" style="margin-top:6px; display:none">
          <div class="row" style="justify-content:space-between">
            <div class="muted">列定義（複数可）</div>
            <div class="hint">型例：INT, BIGINT, VARCHAR(255), TEXT, TIMESTAMP など</div>
          </div>
          <div id="defGrid" class="vstack" style="margin-top:6px"></div>
          <div class="row" style="margin-top:6px">
            <button class="btn small" id="addDef">＋ 列を追加</button>
          </div>
        </div>

        <!-- 生成・クリア -->
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="b_make">SQLを作る → 入力に反映</button>
          <button class="btn danger small" id="b_clear">ビルダー入力をクリア</button>
        </div>

        <div class="muted" style="margin-top:8px">
          ※本機能は生成補助です。SQLの妥当性はご自身でご確認ください。
        </div>
      </div>

      <!-- 入出力 -->
      <div style="margin-top:10px">
        <div class="muted">入力（SQL）</div>
        <textarea id="input" placeholder="SELECT * from users where id=1 AND status='active' order by created_at desc;"></textarea>
      </div>

      <div style="margin-top:10px">
        <div class="muted">出力</div>
        <pre id="output" class="out"></pre>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOutBottom">コピー</button>
        </div>
      </div>

      <div class="footer">
        使い方：SQLをペースト → 「整形」。最小化したい場合は「ミニファイ」。<br/>
        免責：本ツールの利用によるいかなる損害も開発者は責任を負いません。
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">プライバシー</div>
      このサイトは入力内容をサーバに送信しません。ブラウザ内でのみ処理します。広告を表示する場合、第三者のCookie等が利用されることがあります。
    </div>
    <footer class="site-footer card" style="margin-top:32px;font-size:12px">
      <nav class="footer-nav">
        <a href="/">トップ</a>
        <span class="sep">/</span>
        <a href="https://forms.gle/Ay2dVBVV41A2fJQ27" target="_blank" rel="noopener">お問い合わせ</a>
        <span class="sep">/</span>
        <a href="/privacy.html">プライバシーポリシー</a>
      </nav>
    </footer>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const input = $('#input'), output = $('#output');
    const dialect = $('#dialect'), indent = $('#indent'), uppercase = $('#uppercase');

    // ---- 事前クリーンアップ（ON関連は撤去）
    function preprocessSql(raw) {
      if (!raw) return '';
      let s = raw.replace(/\r\n?/g, '\n');        // 改行を \n に統一
      s = s.replace(/\u3000/g, ' ');              // 全角スペース → 半角
      s = s.replace(/\t+/g, ' ');                 // タブは空白に
      // ; の直後に主要キーワードが続くなら改行を挿入
      s = s.replace(/;[ \t]*(?=\b(WITH|SELECT|INSERT|UPDATE|DELETE|DECLARE|CREATE|ALTER|DROP|MERGE)\b)/gi, ';\n');
      // 行内コメント "-- …" の直後に主要キーワードが続くなら改行を入れる
      s = s.replace(
        /(--[^\n]*?)[ \t]+(?=\b(WITH|SELECT|INSERT|UPDATE|DELETE|MERGE|CREATE|ALTER|DROP|UNION|EXCEPT|INTERSECT|ORDER|GROUP|HAVING|LIMIT|OFFSET)\b)/gi,
        '$1\n'
      );
      // 同一行に "… ) ORDER|GROUP|HAVING" があれば見やすさのために改行（保守的）
      s = s.replace(/([^\n;])\s+(?=\b(ORDER|GROUP|HAVING)\b)/gi, '$1\n');
      // 連続空行は1つに
      s = s.replace(/\n{3,}/g, '\n\n');
      return s;
    }

    // ---- 未完了（括弧）チェック：開き > 閉じ なら未完了
    function hasUnbalancedParens(str) {
      try {
        const opens = (str.match(/\(/g) || []).length;
        const closes = (str.match(/\)/g) || []).length;
        return opens > closes;
      } catch { return false; }
    }

    // --- 方言の保存/復元 ---
    const SAVED_KEY = 'sqlfmt.dialect';
    const saved = localStorage.getItem(SAVED_KEY);
    if (saved && $('#dialect')) { $('#dialect').value = saved; }
    $('#dialect')?.addEventListener('change', e => {
      localStorage.setItem(SAVED_KEY, e.target.value);
    });

    // --- 失敗時に方言を推測 ---
    function detectDialect(sql) {
      const s = sql;
      if (/\bILIKE\b|SIMILAR\s+TO\b|::[a-z_]+\b|\bSERIAL\b|\bRETURNING\b/i.test(s)) return 'postgresql';
      if (/@[a-z_]\w*/i.test(s) || /\bTOP\s+\d+\b/i.test(s) || /\bNVARCHAR\b|\bGO\b|\[.*?\]/.test(s)) return 'tsql';
      if (/`[^`]+`/.test(s) || /\bAUTO_INCREMENT\b|\bUNSIGNED\b/i.test(s)) return 'mysql';
      if (/\bPRAGMA\b|\bWITHOUT\s+ROWID\b/i.test(s)) return 'sqlite';
      if (/\bLIMIT\b/i.test(s)) return 'mysql';
      return 'sql';
    }

    async function tryFormatWith(lang, sql, optBase){
      const opt = { ...optBase, language: lang };
      return window.sqlFormatter.format(sql, opt);
    }

    function formatNow(){
      const sql = input.value || '';
      const pre = preprocessSql(sql);
      if (hasUnbalancedParens(pre)) {
        output.textContent = 'SQL が未完了です。（カッコ閉じ忘れ等）';
        return;
      }
      const baseOpt = {
        tabWidth: Math.max(2, Math.min(8, Number(indent.value) || 2)),
        keywordCase: uppercase.checked ? 'upper' : 'preserve',
        linesBetweenQueries: 1,
      };
      const primary = dialect.value;
      try {
        const res = window.sqlFormatter.format(pre, { ...baseOpt, language: primary });
        output.textContent = res;
        return;
      } catch (e1) {
        const guess = detectDialect(pre);
        if (guess && guess !== primary) {
          try {
            const res2 = window.sqlFormatter.format(pre, { ...baseOpt, language: guess });
            output.textContent = res2;
            if ($('#dialect')) {
              $('#dialect').value = guess;
              localStorage.setItem(SAVED_KEY, guess);
            }
            output.textContent += `\n\n/* note: 方言を自動推測して "${guess}" で整形しました */`;
            return;
          } catch (e2) { /* 次 */ }
        }
        const fallback = ['postgresql','mysql','sqlite','tsql'].filter(x => x !== primary && x !== guess);
        for (const lang of fallback) {
          try {
            const res3 = window.sqlFormatter.format(pre, { ...baseOpt, language: lang });
            output.textContent = res3 + `\n\n/* note: 自動試行で "${lang}" 方言にフォールバック */`;
            if ($('#dialect')) {
              $('#dialect').value = lang;
              localStorage.setItem(SAVED_KEY, lang);
            }
            return;
          } catch {}
        }
        output.textContent = '整形に失敗しました: ' + (e1?.message || e1);
      }
    }

    function minifyNow(){
      const sql = input.value || '';
      const noComments = sql.replace(/--.*?$|\/\*[\s\S]*?\*\//gm,'');
      const mini = noComments.replace(/\s+/g,' ').trim();
      output.textContent = mini;
    }

    $('#formatBtn').addEventListener('click', formatNow);
    $('#minifyBtn').addEventListener('click', minifyNow);
    $('#copyBtn').addEventListener('click', async ()=>{
      const text = output.textContent || '';
      try{ await navigator.clipboard.writeText(text); alert('コピーしました'); } catch{ alert('コピーに失敗しました'); }
    });
        // ===== DEFAULT 候補：方言と型に応じて datalist を差し替え =====
    function normalizeDialect(d){
      const x=(d||'').toLowerCase();
      if(x==='postgres') return 'postgresql';
      if(x==='transactsql') return 'tsql';
      if(x==='sqlserver' || x==='mssql') return 'tsql';
      if(x==='plsql' || x==='oracle') return 'oracle';
      return x||'sql';
    }
    function inferTypeCategory(typeStr){
      const t=(typeStr||'').toLowerCase().replace(/\s+/g,'');
      // 代表的マッピング（必要に応じて拡張可）
      if(/^(int|tinyint|smallint|mediumint|bigint|integer|serial|bigserial|number|numeric|decimal|money)/.test(t)) return 'number';
      if(/^(float|double|real|binary_float|binary_double)/.test(t)) return 'float';
      if(/^(bool|boolean|bit)/.test(t)) return 'bool';
      if(/^(char|nchar|varchar|nvarchar|text|clob|string)/.test(t)) return 'string';
      if(/^(json|jsonb|super)/.test(t)) return 'json';
      if(/^(uuid|uniqueidentifier)/.test(t)) return 'uuid';
      if(/^(date)$/.test(t)) return 'date';
      if(/^(time)/.test(t)) return 'time';
      if(/^(timestamp|datetime|smalldatetime|timestamptz|datetime2)/.test(t)) return 'datetime';
      if(/^(blob|bytea|varbinary|binary)/.test(t)) return 'binary';
      return 'unknown';
    }
    function candidatesByDialectAndType(dialect, typeStr){
      const d = normalizeDialect(dialect);
      const cat = inferTypeCategory(typeStr);
      const baseCommon = ['NULL']; // どの型でもあり得る
      const out = [...baseCommon];
      // 型カテゴリ別の候補
      if(cat==='number' || cat==='float'){ out.push('0','1','-1'); }
      if(cat==='bool'){
        if(d==='postgresql' || d==='trino' || d==='redshift' || d==='bigquery' || d==='oracle'){ out.push('TRUE','FALSE'); }
        else { out.push('1','0','TRUE','FALSE'); } // MySQL/SQLite/T-SQL は 1/0 も一般的
      }
      if(cat==='string'){ out.push("''","'N/A'"); }
      if(cat==='json'){ out.push("'{}'","'[]'"); }
      if(cat==='uuid'){
        if(d==='postgresql'){ out.push('gen_random_uuid()','uuid_generate_v4()'); }
        else if(d==='tsql'){ out.push('NEWID()'); }
        else if(d==='mysql'){ out.push('UUID()'); }
        else { out.push('UUID()'); }
      }
      if(cat==='date'){
        if(d==='oracle'){ out.push('SYSDATE','CURRENT_DATE'); }
        else if(d==='tsql'){ out.push('GETDATE()','CAST(GETDATE() AS DATE)','CURRENT_DATE'); }
        else if(d==='mysql'){ out.push('CURRENT_DATE','CURDATE()'); }
        else { out.push('CURRENT_DATE'); }
      }
      if(cat==='time'){
        if(d==='mysql'){ out.push('CURRENT_TIME','CURTIME()'); }
        else { out.push('CURRENT_TIME'); }
      }
      if(cat==='datetime'){
        if(d==='tsql'){ out.push('GETDATE()','SYSDATETIME()','CURRENT_TIMESTAMP'); }
        else if(d==='oracle'){ out.push('SYSTIMESTAMP','CURRENT_TIMESTAMP'); }
        else if(d==='mysql'){ out.push('CURRENT_TIMESTAMP','NOW()'); }
        else { out.push('CURRENT_TIMESTAMP','NOW()'); }
      }
      // unknown かつ文字列っぽいときの無難候補
      if(cat==='unknown'){ out.push("''"); }
      // 重複除去
      return [...new Set(out)];
    }
    function findDialectSelect(){
      // 既存の方言セレクタを推測（idが #dialect / #formatDialect でない場合も拾う）
      const knownIds = ['#dialect','#formatDialect'];
      for(const id of knownIds){ const el=document.querySelector(id); if(el) return el; }
      const sels=[...document.querySelectorAll('select')];
      const probe = new Set(['sql','mysql','postgresql','sqlite','tsql','oracle','mariadb','bigquery','redshift','trino','hive','spark']);
      for(const s of sels){
        const vals=[...s.querySelectorAll('option')].map(o=>(o.value||o.textContent||'').toLowerCase());
        if(vals.some(v=>probe.has(v))) return s;
      }
      return null;
    }
    function updateDefaultOptionsForRow(row){
      const dl = document.getElementById('defaultOptions'); if(!dl) return;
      const typeInput = row.querySelector('input[placeholder^="型"]');
      const dialectSel = findDialectSelect();
      const dialectVal = dialectSel?.value || 'sql';
      const typeVal = typeInput?.value || '';
      const list = candidatesByDialectAndType(dialectVal, typeVal);
      dl.innerHTML = '';
      list.forEach(v => { const o=document.createElement('option'); o.value=v; dl.appendChild(o); });
    }
    // 既存（静的に置かれている）DEFAULT 入力にもフック
    (function attachDefaultHooksInitial(){
      const rows = document.querySelectorAll('#defGrid .row');
      rows.forEach(r=>{
        const def = r.querySelector('input[placeholder^="DEFAULT"]');
        const typ = r.querySelector('input[placeholder^="型"]');
        if(def){ def.setAttribute('list','defaultOptions'); def.addEventListener('focus', ()=>updateDefaultOptionsForRow(r)); }
        if(typ){ typ.addEventListener('input', ()=>updateDefaultOptionsForRow(r)); }
      });
      // 方言切り替え時、フォーカスしている DEFAULT 入力があれば更新
      const dialectSel = findDialectSelect();
      dialectSel?.addEventListener('change', ()=>{
        const active = document.activeElement;
        if(active && active.matches('input[list="defaultOptions"]')){
          const row = active.closest('.row'); if(row) updateDefaultOptionsForRow(row);
        }
      });
    })();
    // ---- 型候補（datalist）を方言に連動させる ----
    (function(){
      // sql-formatter の方言想定（足りなくてもフォールバックします）
      const TYPE_CATALOG = {
        sql: ['INT','INTEGER','BIGINT','SMALLINT','DECIMAL(10,2)','NUMERIC(10,2)','FLOAT','REAL','DOUBLE','BOOLEAN','CHAR(1)','VARCHAR(255)','TEXT','DATE','TIME','DATETIME','TIMESTAMP','JSON'],
        mysql: ['TINYINT','SMALLINT','MEDIUMINT','INT','BIGINT','DECIMAL(10,2)','FLOAT','DOUBLE','BIT','CHAR(1)','VARCHAR(255)','TEXT','MEDIUMTEXT','LONGTEXT','DATE','TIME','DATETIME','TIMESTAMP','JSON','ENUM(\'A\',\'B\')','SET(\'A\',\'B\')'],
        mariadb: ['TINYINT','SMALLINT','MEDIUMINT','INT','BIGINT','DECIMAL(10,2)','FLOAT','DOUBLE','BIT','CHAR(1)','VARCHAR(255)','TEXT','DATE','TIME','DATETIME','TIMESTAMP','JSON'],
        postgresql: ['SMALLINT','INTEGER','BIGINT','NUMERIC(10,2)','REAL','DOUBLE PRECISION','BOOLEAN','CHAR(1)','VARCHAR(255)','TEXT','DATE','TIME','TIMESTAMP','TIMESTAMPTZ','UUID','JSONB','INET','BYTEA','SERIAL','BIGSERIAL'],
        sqlite: ['INTEGER','REAL','TEXT','BLOB','NUMERIC','DATE','DATETIME'],
        tsql: ['INT','BIGINT','SMALLINT','TINYINT','DECIMAL(10,2)','NUMERIC(10,2)','FLOAT','REAL','BIT','CHAR(1)','NCHAR(10)','VARCHAR(255)','NVARCHAR(255)','TEXT','DATE','TIME','DATETIME','DATETIME2','SMALLDATETIME','UNIQUEIDENTIFIER','MONEY'],
        mssql: ['INT','BIGINT','SMALLINT','TINYINT','DECIMAL(10,2)','NUMERIC(10,2)','FLOAT','REAL','BIT','CHAR(1)','NCHAR(10)','VARCHAR(255)','NVARCHAR(255)','TEXT','DATE','TIME','DATETIME','DATETIME2','SMALLDATETIME','UNIQUEIDENTIFIER','MONEY'],
        oracle: ['NUMBER(10,2)','BINARY_FLOAT','BINARY_DOUBLE','CHAR(1)','NCHAR(10)','VARCHAR2(255)','NVARCHAR2(255)','CLOB','DATE','TIMESTAMP','TIMESTAMP WITH TIME ZONE'],
        plsql: ['NUMBER(10,2)','BINARY_FLOAT','BINARY_DOUBLE','CHAR(1)','NCHAR(10)','VARCHAR2(255)','NVARCHAR2(255)','CLOB','DATE','TIMESTAMP','TIMESTAMP WITH TIME ZONE'],
        bigquery: ['INT64','NUMERIC','BIGNUMERIC','FLOAT64','BOOL','STRING','BYTES','DATE','TIME','DATETIME','TIMESTAMP','GEOGRAPHY','JSON'],
        redshift: ['SMALLINT','INTEGER','BIGINT','DECIMAL(10,2)','REAL','DOUBLE PRECISION','BOOLEAN','CHAR(1)','VARCHAR(255)','SUPER','DATE','TIMESTAMP','TIMESTAMPTZ'],
        hive: ['TINYINT','SMALLINT','INT','BIGINT','FLOAT','DOUBLE','DECIMAL(10,2)','BOOLEAN','STRING','VARCHAR(255)','CHAR(10)','BINARY','DATE','TIMESTAMP'],
        spark: ['TINYINT','SMALLINT','INT','BIGINT','FLOAT','DOUBLE','DECIMAL(10,2)','BOOLEAN','STRING','BINARY','DATE','TIMESTAMP','ARRAY<T>','MAP<K,V>','STRUCT<...>'],
        trino: ['TINYINT','SMALLINT','INTEGER','BIGINT','REAL','DOUBLE','DECIMAL(10,2)','BOOLEAN','CHAR(1)','VARCHAR(255)','VARBINARY','DATE','TIME','TIMESTAMP','TIMESTAMP WITH TIME ZONE','JSON','UUID','IPADDRESS']
      };
      // 方言名のゆらぎ吸収
      function normalizeDialect(d){
        const x = (d||'').toLowerCase();
        if (x==='transactsql') return 'tsql';
        if (x==='postgres' || x==='postgresql') return 'postgresql';
        if (x==='sqlserver' || x==='mssql') return 'mssql';
        if (x==='plsql' || x==='oracle') return 'oracle';
        return x||'sql';
      }
      function setTypeOptions(d){
        const dl = document.getElementById('sqlTypes'); if(!dl) return;
        const norm = normalizeDialect(d);
        const list = TYPE_CATALOG[norm] || TYPE_CATALOG.sql;
        dl.innerHTML = '';
        list.forEach(v=>{
          const opt = document.createElement('option');
          opt.value = v;
          dl.appendChild(opt);
        });
      }
      // 既存の「型」入力（静的に置いてあるもの）にも list を付与しておく
      document.querySelectorAll('input[placeholder^="型"]').forEach(el=> el.setAttribute('list','sqlTypes'));
      // 方言セレクタを見つける（id 名が違っても検出）
      function findDialectSelect(){
        // 候補となる select を全て見て、方言らしい値を持つものを返す
        const candidates = [...document.querySelectorAll('select')];
        const KNOWN = new Set(Object.keys(TYPE_CATALOG));
        for (const sel of candidates){
          const vals = [...sel.querySelectorAll('option')].map(o=>normalizeDialect(o.value||o.textContent));
          const hit = vals.some(v=> KNOWN.has(v));
          if (hit) return sel;
        }
        return null;
      }
      const dialectSel = document.querySelector('#dialect') || document.querySelector('#formatDialect') || findDialectSelect();
      setTypeOptions(dialectSel?.value || 'sql');
      dialectSel?.addEventListener('change', (e)=> setTypeOptions(e.target.value));
    })();
    // 下側コピー（output が <pre> でも <textarea> でも対応）
    $('#copyOutBottom')?.addEventListener('click', async ()=>{
      const el = $('#output');
      const text = el?.value ?? el?.textContent ?? '';
      try{ await navigator.clipboard.writeText(text); alert('コピーしました'); } catch{ alert('コピーに失敗しました'); }
    });
    $('#clearBtn').addEventListener('click', ()=>{
      // SELECT
      $('#b_table').value = '';
      $('#b_order_field').value=''; $('#b_order_dir').value='ASC'; $('#b_limit').value='';
      colsGrid.innerHTML=''; condsGrid.innerHTML=''; joinsGrid.innerHTML='';
      addColRow('*'); addCondRow(condsGrid);        // JOIN は自動追加しない
      // INSERT
      insGrid.innerHTML=''; addInsRow();
      // UPDATE
      setGrid.innerHTML=''; uCondsGrid.innerHTML='';
      addSetRow(); addUCondRow();
      // CREATE
      defGrid.innerHTML=''; addDefRow();
    });

    // タブ切替
    const tabFormat = $('#tabFormat');
    const tabBuilder = $('#tabBuilder');
    const builder = $('#builder');
    function setActiveTab(which){
      if(which==='build'){
        tabBuilder.classList.add('active'); tabFormat.classList.remove('active');
        builder.style.display='block';
        builder.scrollIntoView({behavior:'smooth'});
      }else{
        tabFormat.classList.add('active'); tabBuilder.classList.remove('active');
        builder.style.display='none';
        window.scrollTo({top:0,behavior:'smooth'});
      }
    }
    if (tabFormat && tabBuilder && builder) {
      tabFormat.addEventListener('click', () => setActiveTab('format')); // 初期はformatがactive
      tabBuilder.addEventListener('click', () => setActiveTab('build'));
    }
    // 汎用：削除ボタン（行用）
    function mkDelBtn(){
      const btn = document.createElement('button');
      btn.className = 'btn small';
      btn.textContent = '－ 削除';
      btn.style.alignSelf = 'center';
      btn.addEventListener('click', (e)=> {
        const row = e.target.closest('.row') || e.target.closest('div');
        row?.remove();
      });
      return btn;
    }

    // SELECTエリア UI
    const colsGrid = $('#colsGrid');
    const condsGrid = $('#condsGrid');
    const joinsGrid = $('#joinsGrid');

    function addColRow(val='*'){
      const r = document.createElement('div'); r.className='row'; r.style.justifyContent='stretch';
      const inp = document.createElement('input'); inp.type='text'; inp.placeholder='カラム名'; inp.value=val;
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addColRow(''); }});
      r.appendChild(inp); r.appendChild(mkDelBtn()); colsGrid.appendChild(r); inp.focus();
    }

    // WHERE/UPDATE 条件：先頭要素の AND/OR を隠す（条件行とグループ開始行が対象）
    function refreshCondConnectors(container){
      const items = [...container.querySelectorAll('.cond-row, .group-row.start, .group-row.end')];
      // 最初に実際の式（条件/開始/終了）のインデックスを取得
      let firstIndex = -1;
      for (let i=0;i<items.length;i++){
        const it = items[i];
        if (it.classList.contains('cond-row') || it.classList.contains('start') || it.classList.contains('end')) {
          firstIndex = i; break;
        }
      }
      // 直前が（開始）かどうかで接続詞の表示可否を決定
      let prevWasStart = false;
      items.forEach((it,i)=>{
        const conn = it.querySelector?.('.cond-conn');
        if (!conn) { prevWasStart = it.classList.contains('start'); return; }
        // 終了行は常に非表示
        if (it.classList.contains('end')) { conn.style.display='none'; prevWasStart=false; return; }
        // 先頭行は非表示
        if (i===firstIndex) { conn.style.display='none'; prevWasStart = it.classList.contains('start'); return; }
        // 直前が（開始）だったら非表示、それ以外は表示
        conn.style.display = prevWasStart ? 'none' : 'inline-block';
        prevWasStart = it.classList.contains('start');
      });
    }

    // 条件 1 行を追加（target は condsGrid / uCondsGrid のいずれか）
    function addCondRow(target=condsGrid, {field='',op='=',value='',conn='AND'}={}){
      const r = document.createElement('div'); r.className='row cond-row';
      const connSel = document.createElement('select'); connSel.className='cond-conn';
      ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
      connSel.value = conn;
      const f = document.createElement('input'); f.type='text'; f.placeholder='フィールド名'; f.value=field;
      const o = document.createElement('select'); o.className='cond-op';
      ['=','!=','>','<','>=','<=','LIKE','IN','IS NULL','IS NOT NULL'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; o.appendChild(opt); });
      o.value=op;

      // 値入力はラッパー内に動的生成（IS NULL/IS NOT NULL のときは要素ごと削除）
      const valWrap = document.createElement('span'); valWrap.className='cond-val-wrap';
      let v = null; // 現在の値入力 input 参照
      const createValueInput = ()=>{
        if (v) return;
        v = document.createElement('input');
        v.type='text';
        v.placeholder="値";
        v.value = value;
        v.className='cond-val';
        v.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addCondRow(target); }});
        valWrap.appendChild(v);
      };
      const removeValueInput = ()=>{
        if (!v) return;
        v.remove();
        v = null;
      };
      const onOpChange = ()=>{
        const noVal = (o.value==='IS NULL' || o.value==='IS NOT NULL');
        if (noVal){ removeValueInput(); }
        else { createValueInput(); }
      };
      o.addEventListener('change', onOpChange);
      // 初期表示（既定opに応じて生成/削除）
      onOpChange();

      // 行削除
      const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
      del.addEventListener('click', ()=>{ r.remove(); refreshCondConnectors(target); });
      r.appendChild(connSel); r.appendChild(f); r.appendChild(o); r.appendChild(valWrap); r.appendChild(del)
      target.appendChild(r);
      refreshCondConnectors(target);
      f.focus();
    }

    // （ 開始 行を追加
    function addCondGroupStart(target=condsGrid, {conn='AND'}={}){
      const r = document.createElement('div'); r.className='row group-row start';
      const connSel = document.createElement('select'); connSel.className='cond-conn';
      ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
      connSel.value = conn;
      const label = document.createElement('span'); label.textContent = '('; label.style.padding='6px 8px'; label.style.border='1px solid #334155'; label.style.borderRadius='8px';
      const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
      del.addEventListener('click', ()=>{ r.remove(); refreshCondConnectors(target); });
      r.appendChild(connSel); r.appendChild(label); r.appendChild(del);
      target.appendChild(r);
      refreshCondConnectors(target);
    }

    // ） 終了 行を追加（接続詞は持たない）
    function addCondGroupEnd(target=condsGrid){
      const r = document.createElement('div'); r.className='row group-row end';
      const spacer = document.createElement('span'); spacer.textContent = ')'; spacer.style.padding='6px 8px'; spacer.style.border='1px solid #334155'; spacer.style.borderRadius='8px';
      const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
      del.addEventListener('click', ()=>{ r.remove(); refreshCondConnectors(target); });
      r.appendChild(spacer); r.appendChild(del);
      target.appendChild(r);
      refreshCondConnectors(target);
    }    

    // JOIN：接続詞表示制御（条件行＆グループ開始は先頭で非表示、グループ終了は常に非表示）
    function refreshJoinConnectors(block){
      const items = [...block.querySelectorAll('.join-cond-row, .join-group.start, .join-group.end')];
      let firstIdx = -1;
      for (let i=0;i<items.length;i++){
        const it = items[i];
        if (it.classList.contains('join-cond-row') || it.classList.contains('start') || it.classList.contains('end')) { firstIdx = i; break; }
      }
      let prevWasStart = false;
      items.forEach((it,i)=>{
        const conn = it.querySelector?.('.join-cond-conn');
        if (!conn) { prevWasStart = it.classList.contains('start'); return; }
        if (it.classList.contains('end')) { conn.style.display='none'; prevWasStart=false; return; }
        if (i===firstIdx) { conn.style.display='none'; prevWasStart = it.classList.contains('start'); return; }
        conn.style.display = prevWasStart ? 'none' : 'inline-block';
        prevWasStart = it.classList.contains('start');
      });

      // ▼ 先頭の「条件行」の左にだけ ON ラベルを表示（表示専用）
      // いったん既存の ON チップを全削除してから、先頭の条件行に付け直す
      block.querySelectorAll('.on-chip').forEach(n => n.remove());
      const firstCondRow = items.find(el => el.classList.contains('join-cond-row'));
      if (firstCondRow) {
        const chip = document.createElement('span');
        chip.textContent = 'ON';
        chip.className = 'on-chip';
        chip.style.padding = '6px 8px';
        chip.style.border = '1px solid #334155';
        chip.style.borderRadius = '8px';
        chip.style.marginRight = '4px';
        // 行の先頭に差し込む（先頭の AND/OR セレクタは先頭行では非表示になる想定）
        firstCondRow.insertBefore(chip, firstCondRow.firstChild);
      }
    }

    // JOIN の ON 条件 1 行を追加（AND/OR セレクタ付き）
    function addJoinCondRow(block, {l='', op='=', r='', conn='AND'}={}) {
      const conds = block.querySelector('.join-conds');
      const row = document.createElement('div');
      row.className = 'row join-cond-row';

      const connSel = document.createElement('select'); connSel.className='join-cond-conn';
      ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
      connSel.value = conn;

      const onL = document.createElement('input'); onL.type='text'; onL.placeholder='左側条件'; onL.value=l; onL.className='join-on-left';

      // JOIN の演算子を WHERE と同等に拡張
      const onOp = document.createElement('select'); onOp.className='join-on-op';
      ['=','!=','>','<','>=','<=','LIKE','IN','IS NULL','IS NOT NULL'].forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; onOp.appendChild(o);
      });
      onOp.value = op;

      // 右辺入力は IS NULL/IS NOT NULL の時は DOM ごと消す
      const rightWrap = document.createElement('span'); rightWrap.className='join-right-wrap';
      let onR = null;
      const createRight = ()=>{
        if(onR) return;
        onR = document.createElement('input');
        onR.type='text';
        onR.placeholder='右側条件';
        onR.value = r;
        onR.className='join-on-right';
        rightWrap.appendChild(onR);
      };
      const removeRight = ()=>{
        if(!onR) return;
        onR.remove(); onR=null;
      };
      const switchRightByOp = ()=>{
        const noRight = (onOp.value==='IS NULL' || onOp.value==='IS NOT NULL');
        if(noRight) removeRight(); else createRight();
      };
      onOp.addEventListener('change', switchRightByOp);
      // 初期表示
      switchRightByOp();

      const delBtn = document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='－ 削除';
      delBtn.addEventListener('click', ()=>{ row.remove(); refreshJoinConnectors(block); });

      row.appendChild(connSel); row.appendChild(onL); row.appendChild(onOp); row.appendChild(rightWrap); row.appendChild(delBtn);
      conds.appendChild(row);
      refreshJoinConnectors(block);
      onL.focus();
    }

  // JOIN グループ開始（（）
  function addJoinGroupStart(block,{conn='AND'}={}){
    const conds = block.querySelector('.join-conds');
    const row = document.createElement('div'); row.className='row join-group start';
    const connSel = document.createElement('select'); connSel.className='join-cond-conn';
    ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
    connSel.value = conn;
    const chip = document.createElement('span'); chip.textContent='('; chip.style.padding='6px 8px'; chip.style.border='1px solid #334155'; chip.style.borderRadius='8px';
    const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
    del.addEventListener('click', ()=>{ row.remove(); refreshJoinConnectors(block); });
    row.appendChild(connSel); row.appendChild(chip); row.appendChild(del);
    conds.appendChild(row);
    refreshJoinConnectors(block);
  }

  // JOIN グループ終了（ ））
  function addJoinGroupEnd(block){
    const conds = block.querySelector('.join-conds');
    const row = document.createElement('div'); row.className='row join-group end';
    const chip = document.createElement('span'); chip.textContent=')'; chip.style.padding='6px 8px'; chip.style.border='1px solid #334155'; chip.style.borderRadius='8px';
    const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
    del.addEventListener('click', ()=>{ row.remove(); refreshJoinConnectors(block); });
    row.appendChild(chip); row.appendChild(del);
    conds.appendChild(row);
    refreshJoinConnectors(block);
  }

    // JOIN ブロック全体を追加（枠ごと削除可能）
    function addJoinRow(){
      const block = document.createElement('div');
      block.className = 'card join-block';
      block.style.padding = '10px';
      block.style.background = '#0b1220';
      block.style.border = '1px solid #243045';

      const head = document.createElement('div'); head.className='row';
      const jtSel = document.createElement('select'); jtSel.className='join-type';
      ['INNER JOIN','LEFT OUTER JOIN','RIGHT OUTER JOIN','FULL OUTER JOIN'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; jtSel.appendChild(o); });
      const table = document.createElement('input'); table.type='text'; table.placeholder='結合先テーブル名'; table.className='join-table';
      const addCondBtn = document.createElement('button'); addCondBtn.className='btn small'; addCondBtn.textContent='＋ 条件を追加';
      const gOpenBtn  = document.createElement('button'); gOpenBtn.className='btn small';  gOpenBtn.textContent='（ 開始';
      const gCloseBtn = document.createElement('button'); gCloseBtn.className='btn small'; gCloseBtn.textContent='） 終了';
      const delJoinBtn = document.createElement('button'); delJoinBtn.className='btn small danger'; delJoinBtn.textContent='－ 結合を削除';
      delJoinBtn.addEventListener('click', ()=> block.remove());
      head.appendChild(jtSel); head.appendChild(table);
      head.appendChild(addCondBtn); head.appendChild(gOpenBtn); head.appendChild(gCloseBtn);
      head.appendChild(delJoinBtn);

      const conds = document.createElement('div'); conds.className='vstack join-conds'; conds.style.marginTop='6px';

      block.appendChild(head);
      block.appendChild(conds);
      joinsGrid.appendChild(block);

      // 初期は条件行を自動追加しない（必要に応じて追加）
      addCondBtn.addEventListener('click', ()=> addJoinCondRow(block));
      gOpenBtn.addEventListener('click', ()=> addJoinGroupStart(block));
      gCloseBtn.addEventListener('click', ()=> addJoinGroupEnd(block));
    }

    // INSERTエリア UI
    const insGrid = $('#insGrid');
    function addInsRow(){
      const r = document.createElement('div'); r.className = 'row';
      const c = document.createElement('input'); c.type='text'; c.placeholder='列名';
      const v = document.createElement('input'); v.type='text'; v.placeholder="値";
      v.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addInsRow(); }});
      r.appendChild(c); r.appendChild(v); r.appendChild(mkDelBtn()); insGrid.appendChild(r); c.focus();
    }

    // UPDATEエリア UI
    const setGrid = $('#setGrid');
    const uCondsGrid = $('#uCondsGrid');
    function addSetRow(){
      const r = document.createElement('div'); r.className='row';
      const f = document.createElement('input'); f.type='text'; f.placeholder='カラム名';
      const v = document.createElement('input'); v.type='text'; v.placeholder="値";
      v.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addSetRow(); }});
      r.appendChild(f); r.appendChild(v); r.appendChild(mkDelBtn()); setGrid.appendChild(r); f.focus();
    }
    function addUCondRow(){ addCondRow(uCondsGrid); }

    // CREATE TABLEエリア UI
    const defGrid = $('#defGrid');
    function addDefRow(){
      const r = document.createElement('div'); r.className='row';
      const name = document.createElement('input'); name.type='text'; name.placeholder='列名';
      const type = document.createElement('input'); type.type='text'; type.placeholder='型'; type.setAttribute('list','sqlTypes');
      const nullable = document.createElement('select'); ['NOT NULL','NULL'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; nullable.appendChild(o); });
      const def = document.createElement('input'); def.type='text'; def.placeholder="DEFAULT"; def.setAttribute('list','defaultOptions');
      const pk = document.createElement('select'); ['','PRIMARY KEY'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v||'（PKなし）'; pk.appendChild(o); });
      r.appendChild(name); r.appendChild(type); r.appendChild(nullable); r.appendChild(def); r.appendChild(pk); r.appendChild(mkDelBtn()); defGrid.appendChild(r); name.focus();
      type.addEventListener('input', ()=> updateDefaultOptionsForRow(r));
      def.addEventListener('focus', ()=> updateDefaultOptionsForRow(r));
    }

    // ボタン紐付け
    $('#addCol').addEventListener('click', ()=> addColRow(''));
    $('#addCond').addEventListener('click', ()=> addCondRow(condsGrid));
    $('#addCondGroupStart').addEventListener('click', ()=> addCondGroupStart(condsGrid));
    $('#addCondGroupEnd').addEventListener('click', ()=> addCondGroupEnd(condsGrid));
    $('#addJoin').addEventListener('click', ()=> addJoinRow());
    $('#addIns').addEventListener('click', ()=> addInsRow());
    $('#addSet').addEventListener('click', ()=> addSetRow());
    $('#addUCond').addEventListener('click', ()=> addUCondRow());
    $('#addUCondGroupStart').addEventListener('click', ()=> addCondGroupStart(uCondsGrid));
    $('#addUCondGroupEnd').addEventListener('click', ()=> addCondGroupEnd(uCondsGrid));
    $('#addDef').addEventListener('click', ()=> addDefRow());

    // OP 切り替え表示
    const opSel = $('#op');
    const area_select = $('#area_select');
    const area_insert = $('#area_insert');
    const area_update = $('#area_update');
    const area_create = $('#area_create');
    function updateOpView(){
      const op = opSel.value;
      area_select.style.display = (op==='select')?'flex':'none';
      area_insert.style.display = (op==='insert')?'flex':'none';
      area_update.style.display = (op==='update')?'flex':'none';
      area_create.style.display = (op==='create')?'flex':'none';
      $('#row_table').style.display = (op==='create' || op==='select' || op==='insert' || op==='update') ? 'flex' : 'none';
    }
    opSel.addEventListener('change', updateOpView);

    // 初期セットアップ
    function initDefaults(){
      // SELECT（JOIN は追加しない）
      colsGrid.innerHTML=''; condsGrid.innerHTML=''; joinsGrid.innerHTML='';
      addColRow('*'); addCondRow(condsGrid);
      // INSERT
      insGrid.innerHTML=''; addInsRow();
      // UPDATE
      setGrid.innerHTML=''; uCondsGrid.innerHTML=''; addSetRow(); addUCondRow();
      // CREATE
      defGrid.innerHTML=''; addDefRow();
      updateOpView();
    }
    initDefaults();
    formatNow();


    // =========================
    // SQLビルダー → SQL文字列生成
    // =========================
    function buildSelectSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      // カラム
      const cols = [...colsGrid.querySelectorAll('.row input[type="text"]')]
        .map(i=>i.value.trim()).filter(Boolean);
      const colPart = cols.length? cols.join(', ') : '*';
      let sql = `SELECT ${colPart}\nFROM ${table}`;
      // JOIN（グルーピング対応：空行スキップ、括弧直後は接続詞を出さない、括弧整合チェック）
      const joinBlocks = [...joinsGrid.querySelectorAll('.join-block')];
      joinBlocks.forEach(block=>{
        const jt = (block.querySelector('.join-type')?.value)||'INNER JOIN';
        const jtTable = (block.querySelector('.join-table')?.value||'').trim();
        if(!jtTable) return;
        const rows = [...block.querySelectorAll('.join-cond-row, .join-group.start, .join-group.end')];
        const parts=[]; let opened=0;
        // 直前に接続詞が必要かどうか（= 直前が条件 or 閉じ括弧 のとき true / 直前が開き括弧 or 何も無いとき false）
        let needConn = false;
        for(const r of rows){
          if (r.classList.contains('join-cond-row')){
            const l  =(r.querySelector('.join-on-left')?.value||'').trim();
            const op =(r.querySelector('.join-on-op')?.value||'=').trim();
            const rr =(r.querySelector('.join-on-right')?.value||'').trim();
            if(!l) continue;
            let one='';
            if(op==='IS NULL' || op==='IS NOT NULL'){ one = `${l} ${op}`; }
            else { if(!rr) continue; one = `${l} ${op} ${rr}`; }
            if(needConn){
              const conn=(r.querySelector('.join-cond-conn')?.value||'AND').trim();
              parts.push(`${conn} ${one}`);
            }else{
              parts.push(one);
            }
            needConn = true; // 次からは接続詞が必要
          } else if (r.classList.contains('join-group') && r.classList.contains('start')){
            const conn=(r.querySelector('.join-cond-conn')?.value||'AND').trim();
            if(needConn){ parts.push(`${conn} (`); } else { parts.push('('); }
            opened++;
            needConn = false; // 開き括弧の直後なので接続詞は不要
          } else if (r.classList.contains('join-group') && r.classList.contains('end')){
            if (opened<=0){ alert('JOIN の括弧が未完了です。'); return; }
            parts.push(')');
            opened--;
            needConn = true; // 閉じ括弧の後は接続詞が必要
          }
        }
        if (opened!==0){ alert('JOIN の括弧が未完了です。'); return; }
        if(parts.length){ sql += `\n${jt} ${jtTable} ON ${parts.join(' ')}`; }
      });

      // WHERE（グルーピング対応）
      const whereStr = buildWhereClause(condsGrid);
      if (whereStr === null) { alert('WHERE の括弧が未完了です。'); return ''; }
      if (whereStr) sql += `\nWHERE ${whereStr}`;

      // ORDER
      const of = ($('#b_order_field').value||'').trim();
      if(of){
        const dir = ($('#b_order_dir').value||'ASC').trim();
        sql += `\nORDER BY ${of} ${dir}`;
      }
      // LIMIT
      const lim = Number($('#b_limit').value||'');
      if(lim>0){ sql += `\nLIMIT ${lim}`; }
      return sql + ';';
    }

    function buildInsertSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      const rows = [...insGrid.querySelectorAll('.row')];
      const cols=[], vals=[];
      rows.forEach(r=>{
        const [cEl,vEl] = r.querySelectorAll('input');
        const c=(cEl?.value||'').trim();
        const v=(vEl?.value||'').trim();
        if(c && v){ cols.push(c); vals.push(v); }
      });
      if(!cols.length) return '';
      return `INSERT INTO ${table} (${cols.join(', ')})\nVALUES (${vals.join(', ')});`;
    }

    function buildUpdateSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      const setRows = [...setGrid.querySelectorAll('.row')];
      const sets = setRows.map(r=>{
        const [fEl,vEl] = r.querySelectorAll('input');
        const f=(fEl?.value||'').trim();
        const v=(vEl?.value||'').trim();
        if(!f||!v) return '';
        return `${f} = ${v}`;
      }).filter(Boolean);
      if(!sets.length) return '';
      let sql = `UPDATE ${table}\nSET ${sets.join(', ')}`;

      // UPDATE の WHERE（グルーピング対応）
      const uWhere = buildWhereClause(uCondsGrid);
      if (uWhere === null) { alert('WHERE の括弧が未完了です。'); return ''; }
      if (uWhere) sql += `\nWHERE ${uWhere}`;
      return sql + ';';
    }

    // 共通：WHERE 句を組み立て（グルーピング対応・「(」直後は接続詞を付けない）
    // 戻り値： ''（条件なし） / 'expr ...'（成功） / null（括弧不整合）
    function buildWhereClause(container){
      const rows = [...container.querySelectorAll('.cond-row, .group-row.start, .group-row.end')];
      const parts = [];
      let opened = 0;
      // 直前が条件 or 「)」なら接続詞が必要、直前が「(」または先頭なら不要
      let needConn = false;
      for (const r of rows){
        if (r.classList.contains('cond-row')){
          const f =(r.querySelector('input[type="text"]')?.value||'').trim();
          const o =(r.querySelector('.cond-op')?.value||'=').trim();
          const v =(r.querySelector('.cond-val')?.value||'').trim();
          if(!f) continue;
          let expr = '';
          if (o==='IS NULL' || o==='IS NOT NULL') expr = `${f} ${o}`;
          else if (v) expr = `${f} ${o} ${v}`;
          if(!expr) continue;
          if (needConn){
            const conn=(r.querySelector('.cond-conn')?.value||'AND').trim();
            parts.push(`${conn} ${expr}`);
          } else {
            parts.push(expr);
          }
          needConn = true; // 次は接続詞が必要
        } else if (r.classList.contains('group-row') && r.classList.contains('start')){
          const conn=(r.querySelector('.cond-conn')?.value||'AND').trim();
          if (needConn) parts.push(`${conn} (`); else parts.push('(');
          opened++;
          needConn = false; // 「(」直後は接続詞不要
        } else if (r.classList.contains('group-row') && r.classList.contains('end')){
          if (opened<=0) return null; // 閉じ過ぎ
          parts.push(')');
          opened--;
          needConn = true; // 「)」の後は接続詞が必要
        }
      }
      if (opened!==0) return null; // 未クローズ
      return parts.join(' ');
    }

    function buildCreateSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      const defs = [...defGrid.querySelectorAll('.row')].map(r=>{
        const [nameEl,typeEl,nullEl,defEl,pkEl] = r.querySelectorAll('input,select');
        const name=(nameEl?.value||'').trim();
        const type=(typeEl?.value||'').trim();
        const nul =(nullEl?.value||'').trim(); // 'NOT NULL' or 'NULL'
        const defv=(defEl?.value||'').trim();
        const pk  =(pkEl?.value||'').trim();   // '' or 'PRIMARY KEY'
        if(!name||!type) return '';
        return [
          `${name} ${type}`,
          nul || '',
          defv? `DEFAULT ${defv}` : '',
          pk || ''
        ].filter(Boolean).join(' ');
      }).filter(Boolean);
      if(!defs.length) return '';
      return `CREATE TABLE ${table} (\n  ${defs.join(',\n  ')}\n);`;
    }

    // 「SQLを作る → 入力に反映」
    $('#b_make')?.addEventListener('click', ()=>{
      const op = $('#op').value;
      let sql = '';
      if(op==='select') sql = buildSelectSQL();
      else if(op==='insert') sql = buildInsertSQL();
      else if(op==='update') sql = buildUpdateSQL();
      else if(op==='create') sql = buildCreateSQL();
      if(!sql){
        alert('必要な入力が不足しています（テーブル名や項目など）');
        return;
      }
      input.value = sql;
      // 直後に整形して出力へ
      formatNow();
      // 入力欄までスクロール（任意）
      input.scrollIntoView({behavior:'smooth', block:'center'});
    });

  </script>
  <!-- 型候補（datalist：選択も自由入力も可） -->
  <datalist id="sqlTypes">
    <option value="INT"></option>
    <option value="INTEGER"></option>
    <option value="BIGINT"></option>
    <option value="SMALLINT"></option>
    <option value="TINYINT"></option>
    <option value="DECIMAL(10,2)"></option>
    <option value="NUMERIC(10,2)"></option>
    <option value="FLOAT"></option>
    <option value="REAL"></option>
    <option value="DOUBLE"></option>
    <option value="BOOLEAN"></option>
    <option value="BIT"></option>
    <option value="CHAR(1)"></option>
    <option value="NCHAR(10)"></option>
    <option value="VARCHAR(255)"></option>
    <option value="NVARCHAR(255)"></option>
    <option value="TEXT"></option>
    <option value="DATE"></option>
    <option value="TIME"></option>
    <option value="DATETIME"></option>
    <option value="DATETIME2"></option>
    <option value="TIMESTAMP"></option>
    <option value="UUID"></option>
    <option value="UNIQUEIDENTIFIER"></option>
    <option value="JSON"></option>
  </datalist>
  <datalist id="sqlTypes"></datalist>
  <datalist id="defaultOptions"></datalist>
</body>
</html>
