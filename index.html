<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL整形ツール（高速・無料・ブラウザだけ）</title>
  <meta name="description" content="SQLをブラウザだけでサッと整形・作成。MySQL/PostgreSQL/SQLite/SQL Server対応。データ送信なし＆完全無料。" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --fg:#e5e7eb; --acc:#22d3ee; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .title{font-size:24px;font-weight:800;letter-spacing:.5px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgb(0 0 0 / .25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row > *{margin:4px 0}
    select, input[type="number"], input[type="checkbox"], input[type="text"]{background:#0b1220;border:1px solid #243045;color:var(--fg);border-radius:10px;padding:8px 10px}
    input[type="text"]{min-width:220px}
    textarea{width:100%;min-height:180px;background:#0b1220;border:1px solid #243045;border-radius:12px;color:var(--fg);padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .out{min-height:220px;white-space:pre;overflow:auto}
    .btn{background:#0b1220;border:1px solid #334155;color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#475569}
    .btn.primary{border-color:#0ea5b7;background:linear-gradient(180deg,#0ea5b7,#0b7782);font-weight:700}
    .btn.small{padding:6px 10px;border-radius:8px}
    .muted{color:var(--muted);font-size:13px}
    .footer{margin-top:18px;color:#9ca3af;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#cbd5e1}
    .hint{font-size:12px;color:#a1a1aa}
    .danger{border-color:#ef4444 !important;color:#fecaca !important}
    .vstack{display:flex;flex-direction:column;gap:10px}
  </style>
  <!-- sql-formatter（UMD） -->
  <script src="https://unpkg.com/sql-formatter/dist/sql-formatter.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="title">SQL整形ツール</div>
      <div class="badge">ローカル実行 / データ送信なし</div>
    </div>

    <div class="card" style="margin-top:14px">
      <!-- ツールバー -->
      <div class="row">
        <label>方言
          <select id="dialect">
            <option value="sql">Standard SQL</option>
            <option value="mysql">MySQL</option>
            <option value="postgresql">PostgreSQL</option>
            <option value="sqlite">SQLite</option>
            <option value="tsql">SQL Server (T-SQL)</option>
          </select>
        </label>
        <label>インデント
          <input id="indent" type="number" min="2" max="8" step="1" value="2" />
        </label>
        <label><input id="uppercase" type="checkbox" /> キーワードを大文字に</label>

        <button class="btn primary" id="formatBtn">整形</button>
        <button class="btn" id="minifyBtn">ミニファイ</button>
        <button class="btn" id="copyBtn">コピー</button>
        <button class="btn" id="clearBtn">クリア</button>
      </div>

      <!-- 方言ヒント -->
      <div class="muted" style="margin-top:6px">
        ヒント：T-SQL（@変数, TOP）は「SQL Server (T-SQL)」、PostgreSQL（ILIKE, ::cast）は「PostgreSQL」など、方言を切り替えると整形しやすくなります。
      </div>

      <!-- タブ切替 -->
      <div class="row" style="margin-top:8px">
        <button class="btn" id="tabFormat">整形ツール</button>
        <button class="btn" id="tabBuilder">SQL作成</button>
      </div>

      <!-- ===== SQLビルダー：オペレーション対応 ===== -->
      <div id="builder" class="card" style="margin-top:12px; display:none">
        <!-- 操作選択 -->
        <div class="row">
          <label>操作
            <select id="op">
              <option value="select">SELECT</option>
              <option value="insert">INSERT</option>
              <option value="update">UPDATE</option>
              <option value="create">CREATE TABLE</option>
            </select>
          </label>
        </div>

        <!-- 共通：テーブル名 -->
        <div class="row" id="row_table">
          <label>テーブル名 <input id="b_table" type="text" placeholder="users" /></label>
        </div>

        <!-- --- SELECT 専用エリア --- -->
        <div id="area_select" class="vstack" style="margin-top:6px">
          <!-- カラム -->
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">カラム（複数可）</div>
              <div class="hint">空欄は無視／Enterで追加</div>
            </div>
            <div id="colsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addCol">＋ カラムを追加</button>
            </div>
          </div>

          <!-- JOIN -->
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">JOIN（複数可）</div>
              <div class="hint">ON は「左側」「演算子」「右側」を1行として追加。2行目以降は先頭で AND/OR を選択。</div>
            </div>
            <div id="joinsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addJoin">＋ JOINを追加</button>
            </div>
          </div>

          <!-- 条件 -->
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">条件（WHERE：複数可／AND結合）</div>
              <div class="hint">例：created_at >= '2025-01-01'</div>
            </div>
            <div id="condsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addCond">＋ 条件を追加</button>
              <button class="btn small" id="addCondGroupStart">（ 開始</button>
              <button class="btn small" id="addCondGroupEnd">） 終了</button>
            </div>
          </div>

          <!-- ORDER / LIMIT -->
          <div class="row" style="margin-top:6px">
            <label>並び順（ORDER BY）
              <input id="b_order_field" type="text" placeholder="created_at" />
            </label>
            <label>方向
              <select id="b_order_dir">
                <option value="ASC" selected>ASC</option>
                <option value="DESC">DESC</option>
              </select>
            </label>
            <label>件数（LIMIT）
              <input id="b_limit" type="number" min="1" placeholder="100" style="width:100px"/>
            </label>
          </div>
        </div>

        <!-- --- INSERT 専用エリア --- -->
        <div id="area_insert" class="vstack" style="margin-top:6px; display:none">
          <div class="row" style="justify-content:space-between">
            <div class="muted">列と値（複数可）</div>
            <div class="hint">値はクォート等を含めて入力（例：'Alice', 123, NOW()）</div>
          </div>
          <div id="insGrid" class="vstack" style="margin-top:6px"></div>
          <div class="row" style="margin-top:6px">
            <button class="btn small" id="addIns">＋ 行を追加</button>
          </div>
        </div>

        <!-- --- UPDATE 専用エリア --- -->
        <div id="area_update" class="vstack" style="margin-top:6px; display:none">
          <div>
            <div class="row" style="justify-content:space-between">
              <div class="muted">SET（フィールド＝値：複数可）</div>
              <div class="hint">値はクォート等を含めて入力（例：name='Alice', count=count+1）</div>
            </div>
            <div id="setGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addSet">＋ SETを追加</button>
            </div>
          </div>

          <div style="margin-top:8px">
            <div class="row" style="justify-content:space-between">
              <div class="muted">条件（WHERE：複数可／AND結合）</div>
            </div>
            <div id="uCondsGrid" class="vstack" style="margin-top:6px"></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="addUCond">＋ 条件を追加</button>
              <button class="btn small" id="addUCondGroupStart">（ 開始</button>
              <button class="btn small" id="addUCondGroupEnd">） 終了</button>
            </div>
          </div>
        </div>

        <!-- --- CREATE TABLE 専用エリア --- -->
        <div id="area_create" class="vstack" style="margin-top:6px; display:none">
          <div class="row" style="justify-content:space-between">
            <div class="muted">列定義（複数可）</div>
            <div class="hint">型例：INT, BIGINT, VARCHAR(255), TEXT, TIMESTAMP など</div>
          </div>
          <div id="defGrid" class="vstack" style="margin-top:6px"></div>
          <div class="row" style="margin-top:6px">
            <button class="btn small" id="addDef">＋ 列を追加</button>
          </div>
        </div>

        <!-- 生成・クリア -->
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="b_make">SQLを作る → 入力に反映</button>
          <button class="btn danger small" id="b_clear">ビルダー入力をクリア</button>
        </div>

        <div class="muted" style="margin-top:8px">
          ※本機能は生成補助です。SQLの妥当性はご自身でご確認ください。
        </div>
      </div>

      <!-- 入出力 -->
      <div style="margin-top:10px">
        <div class="muted">入力（SQL）</div>
        <textarea id="input" placeholder="SELECT * from users where id=1 AND status='active' order by created_at desc;"></textarea>
      </div>

      <div style="margin-top:10px">
        <div class="muted">出力</div>
        <pre id="output" class="out"></pre>
      </div>

      <div class="footer">
        使い方：SQLをペースト → 「整形」。最小化したい場合は「ミニファイ」。<br/>
        免責：本ツールの利用によるいかなる損害も開発者は責任を負いません。
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">プライバシー</div>
      このサイトは入力内容をサーバに送信しません。ブラウザ内でのみ処理します。広告を表示する場合、第三者のCookie等が利用されることがあります。
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const input = $('#input'), output = $('#output');
    const dialect = $('#dialect'), indent = $('#indent'), uppercase = $('#uppercase');

    // ---- 事前クリーンアップ（ON関連は撤去）
    function preprocessSql(raw) {
      if (!raw) return '';
      let s = raw.replace(/\r\n?/g, '\n');        // 改行を \n に統一
      s = s.replace(/\u3000/g, ' ');              // 全角スペース → 半角
      s = s.replace(/\t+/g, ' ');                 // タブは空白に
      // ; の直後に主要キーワードが続くなら改行を挿入
      s = s.replace(/;[ \t]*(?=\b(WITH|SELECT|INSERT|UPDATE|DELETE|DECLARE|CREATE|ALTER|DROP|MERGE)\b)/gi, ';\n');
      // 行内コメント "-- …" の直後に主要キーワードが続くなら改行を入れる
      s = s.replace(
        /(--[^\n]*?)[ \t]+(?=\b(WITH|SELECT|INSERT|UPDATE|DELETE|MERGE|CREATE|ALTER|DROP|UNION|EXCEPT|INTERSECT|ORDER|GROUP|HAVING|LIMIT|OFFSET)\b)/gi,
        '$1\n'
      );
      // 同一行に "… ) ORDER|GROUP|HAVING" があれば見やすさのために改行（保守的）
      s = s.replace(/([^\n;])\s+(?=\b(ORDER|GROUP|HAVING)\b)/gi, '$1\n');
      // 連続空行は1つに
      s = s.replace(/\n{3,}/g, '\n\n');
      return s;
    }

    // ---- 未完了（括弧）チェック：開き > 閉じ なら未完了
    function hasUnbalancedParens(str) {
      try {
        const opens = (str.match(/\(/g) || []).length;
        const closes = (str.match(/\)/g) || []).length;
        return opens > closes;
      } catch { return false; }
    }

    // --- 方言の保存/復元 ---
    const SAVED_KEY = 'sqlfmt.dialect';
    const saved = localStorage.getItem(SAVED_KEY);
    if (saved && $('#dialect')) { $('#dialect').value = saved; }
    $('#dialect')?.addEventListener('change', e => {
      localStorage.setItem(SAVED_KEY, e.target.value);
    });

    // --- 失敗時に方言を推測 ---
    function detectDialect(sql) {
      const s = sql;
      if (/\bILIKE\b|SIMILAR\s+TO\b|::[a-z_]+\b|\bSERIAL\b|\bRETURNING\b/i.test(s)) return 'postgresql';
      if (/@[a-z_]\w*/i.test(s) || /\bTOP\s+\d+\b/i.test(s) || /\bNVARCHAR\b|\bGO\b|\[.*?\]/.test(s)) return 'tsql';
      if (/`[^`]+`/.test(s) || /\bAUTO_INCREMENT\b|\bUNSIGNED\b/i.test(s)) return 'mysql';
      if (/\bPRAGMA\b|\bWITHOUT\s+ROWID\b/i.test(s)) return 'sqlite';
      if (/\bLIMIT\b/i.test(s)) return 'mysql';
      return 'sql';
    }

    async function tryFormatWith(lang, sql, optBase){
      const opt = { ...optBase, language: lang };
      return window.sqlFormatter.format(sql, opt);
    }

    function formatNow(){
      const sql = input.value || '';
      const pre = preprocessSql(sql);
      if (hasUnbalancedParens(pre)) {
        output.textContent = 'SQL が未完了です。（カッコ閉じ忘れ等）';
        return;
      }
      const baseOpt = {
        tabWidth: Math.max(2, Math.min(8, Number(indent.value) || 2)),
        keywordCase: uppercase.checked ? 'upper' : 'preserve',
        linesBetweenQueries: 1,
      };
      const primary = dialect.value;
      try {
        const res = window.sqlFormatter.format(pre, { ...baseOpt, language: primary });
        output.textContent = res;
        return;
      } catch (e1) {
        const guess = detectDialect(pre);
        if (guess && guess !== primary) {
          try {
            const res2 = window.sqlFormatter.format(pre, { ...baseOpt, language: guess });
            output.textContent = res2;
            if ($('#dialect')) {
              $('#dialect').value = guess;
              localStorage.setItem(SAVED_KEY, guess);
            }
            output.textContent += `\n\n/* note: 方言を自動推測して "${guess}" で整形しました */`;
            return;
          } catch (e2) { /* 次 */ }
        }
        const fallback = ['postgresql','mysql','sqlite','tsql'].filter(x => x !== primary && x !== guess);
        for (const lang of fallback) {
          try {
            const res3 = window.sqlFormatter.format(pre, { ...baseOpt, language: lang });
            output.textContent = res3 + `\n\n/* note: 自動試行で "${lang}" 方言にフォールバック */`;
            if ($('#dialect')) {
              $('#dialect').value = lang;
              localStorage.setItem(SAVED_KEY, lang);
            }
            return;
          } catch {}
        }
        output.textContent = '整形に失敗しました: ' + (e1?.message || e1);
      }
    }

    function minifyNow(){
      const sql = input.value || '';
      const noComments = sql.replace(/--.*?$|\/\*[\s\S]*?\*\//gm,'');
      const mini = noComments.replace(/\s+/g,' ').trim();
      output.textContent = mini;
    }

    $('#formatBtn').addEventListener('click', formatNow);
    $('#minifyBtn').addEventListener('click', minifyNow);
    $('#copyBtn').addEventListener('click', async ()=>{
      const text = output.textContent || '';
      try{ await navigator.clipboard.writeText(text); alert('コピーしました'); } catch{ alert('コピーに失敗しました'); }
    });
    $('#clearBtn').addEventListener('click', ()=>{
      // SELECT
      $('#b_table').value = '';
      $('#b_order_field').value=''; $('#b_order_dir').value='ASC'; $('#b_limit').value='';
      colsGrid.innerHTML=''; condsGrid.innerHTML=''; joinsGrid.innerHTML='';
      addColRow('*'); addCondRow(condsGrid);        // JOIN は自動追加しない
      // INSERT
      insGrid.innerHTML=''; addInsRow();
      // UPDATE
      setGrid.innerHTML=''; uCondsGrid.innerHTML='';
      addSetRow(); addUCondRow();
      // CREATE
      defGrid.innerHTML=''; addDefRow();
    });

    // タブ切替
    const tabFormat = $('#tabFormat');
    const tabBuilder = $('#tabBuilder');
    const builder = $('#builder');
    if (tabFormat && tabBuilder && builder) {
      tabFormat.addEventListener('click', () => { builder.style.display = 'none'; window.scrollTo({top:0,behavior:'smooth'}); });
      tabBuilder.addEventListener('click', () => { builder.style.display = 'block'; builder.scrollIntoView({behavior:'smooth'}); });
    }

    // 汎用：削除ボタン（行用）
    function mkDelBtn(){
      const btn = document.createElement('button');
      btn.className = 'btn small';
      btn.textContent = '－ 削除';
      btn.style.alignSelf = 'center';
      btn.addEventListener('click', (e)=> {
        const row = e.target.closest('.row') || e.target.closest('div');
        row?.remove();
      });
      return btn;
    }

    // SELECTエリア UI
    const colsGrid = $('#colsGrid');
    const condsGrid = $('#condsGrid');
    const joinsGrid = $('#joinsGrid');

    function addColRow(val='*'){
      const r = document.createElement('div'); r.className='row'; r.style.justifyContent='stretch';
      const inp = document.createElement('input'); inp.type='text'; inp.placeholder='id  または  users.id AS user_id'; inp.value=val;
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addColRow(''); }});
      r.appendChild(inp); r.appendChild(mkDelBtn()); colsGrid.appendChild(r); inp.focus();
    }

    // WHERE/UPDATE 条件：先頭要素の AND/OR を隠す（条件行とグループ開始行が対象）
    function refreshCondConnectors(container){
      const items = [...container.querySelectorAll('.cond-row, .group-row.start, .group-row.end')];
      let firstIndex = -1;
      for (let i=0;i<items.length;i++){
        const it = items[i];
        const hasExpr = it.classList.contains('cond-row') || it.classList.contains('start') || it.classList.contains('end');
        if(!hasExpr) continue;
        firstIndex = i; break;
      }
      items.forEach((it,i)=>{
        const conn = it.querySelector?.('.cond-conn');
        // グループ「終了」には接続詞を常に表示しない
        if (it.classList.contains('end') && conn) conn.style.display = 'none';
        else if (conn) conn.style.display = (i===firstIndex ? 'none' : 'inline-block');
      });
    }

    // 条件 1 行を追加（target は condsGrid / uCondsGrid のいずれか）
    
    function addCondRow(target=condsGrid, {field='',op='=',value='',conn='AND'}={}){
      const r = document.createElement('div'); r.className='row cond-row';
      const connSel = document.createElement('select'); connSel.className='cond-conn';
      ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
      connSel.value = conn;
      const f = document.createElement('input'); f.type='text'; f.placeholder='フィールド（例：created_at）'; f.value=field;
      const o = document.createElement('select'); o.className='cond-op';
      ['=','!=','>','<','>=','<=','LIKE','IN','IS NULL','IS NOT NULL'].forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; o.appendChild(opt); });
      o.value=op;

      // 値入力はラッパー内に動的生成（IS NULL/IS NOT NULL のときは要素ごと削除）
      const valWrap = document.createElement('span'); valWrap.className='cond-val-wrap';
      let v = null; // 現在の値入力 input 参照
      const createValueInput = ()=>{
        if (v) return;
        v = document.createElement('input');
        v.type='text';
        v.placeholder="値（例：'2025-01-01' / ('A','B'))";
        v.value = value;
        v.className='cond-val';
        v.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addCondRow(target); }});
        valWrap.appendChild(v);
      };
      const removeValueInput = ()=>{
        if (!v) return;
        v.remove();
        v = null;
      };
      const onOpChange = ()=>{
        const noVal = (o.value==='IS NULL' || o.value==='IS NOT NULL');
        if (noVal){ removeValueInput(); }
        else { createValueInput(); }
      };
      o.addEventListener('change', onOpChange);
      // 初期表示（既定opに応じて生成/削除）
      onOpChange();

      // 行削除
      const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
      del.addEventListener('click', ()=>{ r.remove(); refreshCondConnectors(target); });
      r.appendChild(connSel); r.appendChild(f); r.appendChild(o); r.appendChild(valWrap); r.appendChild(del)
      target.appendChild(r);
      refreshCondConnectors(target);
      f.focus();
    }

    // （ 開始 行を追加
    function addCondGroupStart(target=condsGrid, {conn='AND'}={}){
      const r = document.createElement('div'); r.className='row group-row start';
      const connSel = document.createElement('select'); connSel.className='cond-conn';
      ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
      connSel.value = conn;
      const label = document.createElement('span'); label.textContent = '('; label.style.padding='6px 8px'; label.style.border='1px solid #334155'; label.style.borderRadius='8px';
      const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
      del.addEventListener('click', ()=>{ r.remove(); refreshCondConnectors(target); });
      r.appendChild(connSel); r.appendChild(label); r.appendChild(del);
      target.appendChild(r);
      refreshCondConnectors(target);
    }

    // ） 終了 行を追加（接続詞は持たない）
    function addCondGroupEnd(target=condsGrid){
      const r = document.createElement('div'); r.className='row group-row end';
      const spacer = document.createElement('span'); spacer.textContent = ')'; spacer.style.padding='6px 8px'; spacer.style.border='1px solid #334155'; spacer.style.borderRadius='8px';
      const del = document.createElement('button'); del.className='btn small'; del.textContent='－ 削除';
      del.addEventListener('click', ()=>{ r.remove(); refreshCondConnectors(target); });
      r.appendChild(spacer); r.appendChild(del);
      target.appendChild(r);
      refreshCondConnectors(target);
    }    

    // JOIN：先頭行の AND/OR を隠す（2行目以降だけ表示）
    function refreshJoinConnectors(block){
      const rows = [...block.querySelectorAll('.join-cond-row')];
      rows.forEach((r,i)=>{
        const conn = r.querySelector('.join-cond-conn');
        if(conn){ conn.style.display = (i===0 ? 'none' : 'inline-block'); }
      });
    }

    // JOIN の ON 条件 1 行を追加（AND/OR セレクタ付き）
    function addJoinCondRow(block, {l='', op='=', r='', conn='AND'}={}) {
      const conds = block.querySelector('.join-conds');
      const row = document.createElement('div');
      row.className = 'row join-cond-row';

      const connSel = document.createElement('select'); connSel.className='join-cond-conn';
      ['AND','OR'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; connSel.appendChild(o); });
      connSel.value = conn;

      const onL = document.createElement('input'); onL.type='text'; onL.placeholder='ON 左側（例：users.id）'; onL.value=l; onL.className='join-on-left';

      // JOIN の演算子を WHERE と同等に拡張
      const onOp = document.createElement('select'); onOp.className='join-on-op';
      ['=','!=','>','<','>=','<=','LIKE','IN','IS NULL','IS NOT NULL'].forEach(v=>{
        const o=document.createElement('option'); o.value=v; o.textContent=v; onOp.appendChild(o);
      });
      onOp.value = op;

      // 右辺入力は IS NULL/IS NOT NULL の時は DOM ごと消す
      const rightWrap = document.createElement('span'); rightWrap.className='join-right-wrap';
      let onR = null;
      const createRight = ()=>{
        if(onR) return;
        onR = document.createElement('input');
        onR.type='text';
        onR.placeholder='ON 右側（例：orders.user_id / (1,2) / NULL）';
        onR.value = r;
        onR.className='join-on-right';
        rightWrap.appendChild(onR);
      };
      const removeRight = ()=>{
        if(!onR) return;
        onR.remove(); onR=null;
      };
      const switchRightByOp = ()=>{
        const noRight = (onOp.value==='IS NULL' || onOp.value==='IS NOT NULL');
        if(noRight) removeRight(); else createRight();
      };
      onOp.addEventListener('change', switchRightByOp);
      // 初期表示
      switchRightByOp();

      const delBtn = document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='－ 削除';
      delBtn.addEventListener('click', ()=>{ row.remove(); refreshJoinConnectors(block); });

      row.appendChild(connSel); row.appendChild(onL); row.appendChild(onOp); row.appendChild(rightWrap); row.appendChild(delBtn);
      conds.appendChild(row);
      refreshJoinConnectors(block);
      onL.focus();
    }

    // JOIN ブロック全体を追加（枠ごと削除可能）
    function addJoinRow(){
      const block = document.createElement('div');
      block.className = 'card join-block';
      block.style.padding = '10px';
      block.style.background = '#0b1220';
      block.style.border = '1px solid #243045';

      const head = document.createElement('div'); head.className='row';
      const jtSel = document.createElement('select'); jtSel.className='join-type';
      ['INNER JOIN','LEFT OUTER JOIN','RIGHT OUTER JOIN','FULL OUTER JOIN'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; jtSel.appendChild(o); });
      const table = document.createElement('input'); table.type='text'; table.placeholder='結合先テーブル（例：orders）'; table.className='join-table';
      const addCondBtn = document.createElement('button'); addCondBtn.className='btn small'; addCondBtn.textContent='＋ 条件を追加';
      const delJoinBtn = document.createElement('button'); delJoinBtn.className='btn small danger'; delJoinBtn.textContent='－ 結合を削除';
      delJoinBtn.addEventListener('click', ()=> block.remove());
      head.appendChild(jtSel); head.appendChild(table); head.appendChild(addCondBtn); head.appendChild(delJoinBtn);

      const conds = document.createElement('div'); conds.className='vstack join-conds'; conds.style.marginTop='6px';

      block.appendChild(head);
      block.appendChild(conds);
      joinsGrid.appendChild(block);

      // 初期は条件行を自動追加しない（必要に応じて追加）
      addCondBtn.addEventListener('click', ()=> addJoinCondRow(block));
    }

    // INSERTエリア UI
    const insGrid = $('#insGrid');
    function addInsRow(){
      const r = document.createElement('div'); r.className = 'row';
      const c = document.createElement('input'); c.type='text'; c.placeholder='列名（例：name）';
      const v = document.createElement('input'); v.type='text'; v.placeholder="値（例：'Alice' / 123 / NOW()）";
      v.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addInsRow(); }});
      r.appendChild(c); r.appendChild(v); r.appendChild(mkDelBtn()); insGrid.appendChild(r); c.focus();
    }

    // UPDATEエリア UI
    const setGrid = $('#setGrid');
    const uCondsGrid = $('#uCondsGrid');
    function addSetRow(){
      const r = document.createElement('div'); r.className='row';
      const f = document.createElement('input'); f.type='text'; f.placeholder='フィールド（例：name）';
      const v = document.createElement('input'); v.type='text'; v.placeholder="値（例：'Alice' / count+1）";
      v.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ addSetRow(); }});
      r.appendChild(f); r.appendChild(v); r.appendChild(mkDelBtn()); setGrid.appendChild(r); f.focus();
    }
    function addUCondRow(){ addCondRow(uCondsGrid); }

    // CREATE TABLEエリア UI
    const defGrid = $('#defGrid');
    function addDefRow(){
      const r = document.createElement('div'); r.className='row';
      const name = document.createElement('input'); name.type='text'; name.placeholder='列名（例：id）';
      const type = document.createElement('input'); type.type='text'; type.placeholder='型（例：INT / VARCHAR(255））';
      const nullable = document.createElement('select'); ['NOT NULL','NULL'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; nullable.appendChild(o); });
      const def = document.createElement('input'); def.type='text'; def.placeholder="DEFAULT（例：0 / 'N/A' / CURRENT_TIMESTAMP）";
      const pk = document.createElement('select'); ['','PRIMARY KEY'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v||'（PKなし）'; pk.appendChild(o); });
      r.appendChild(name); r.appendChild(type); r.appendChild(nullable); r.appendChild(def); r.appendChild(pk); r.appendChild(mkDelBtn()); defGrid.appendChild(r); name.focus();
    }

    // ボタン紐付け
    $('#addCol').addEventListener('click', ()=> addColRow(''));
    $('#addCond').addEventListener('click', ()=> addCondRow(condsGrid));
    $('#addCondGroupStart').addEventListener('click', ()=> addCondGroupStart(condsGrid));
    $('#addCondGroupEnd').addEventListener('click', ()=> addCondGroupEnd(condsGrid));
    $('#addJoin').addEventListener('click', ()=> addJoinRow());
    $('#addIns').addEventListener('click', ()=> addInsRow());
    $('#addSet').addEventListener('click', ()=> addSetRow());
    $('#addUCond').addEventListener('click', ()=> addUCondRow());
    $('#addUCondGroupStart').addEventListener('click', ()=> addCondGroupStart(uCondsGrid));
    $('#addUCondGroupEnd').addEventListener('click', ()=> addCondGroupEnd(uCondsGrid));
    $('#addDef').addEventListener('click', ()=> addDefRow());

    // OP 切り替え表示
    const opSel = $('#op');
    const area_select = $('#area_select');
    const area_insert = $('#area_insert');
    const area_update = $('#area_update');
    const area_create = $('#area_create');
    function updateOpView(){
      const op = opSel.value;
      area_select.style.display = (op==='select')?'flex':'none';
      area_insert.style.display = (op==='insert')?'flex':'none';
      area_update.style.display = (op==='update')?'flex':'none';
      area_create.style.display = (op==='create')?'flex':'none';
      $('#row_table').style.display = (op==='create' || op==='select' || op==='insert' || op==='update') ? 'flex' : 'none';
    }
    opSel.addEventListener('change', updateOpView);

    // 初期セットアップ
    function initDefaults(){
      // SELECT（JOIN は追加しない）
      colsGrid.innerHTML=''; condsGrid.innerHTML=''; joinsGrid.innerHTML='';
      addColRow('*'); addCondRow(condsGrid);
      // INSERT
      insGrid.innerHTML=''; addInsRow();
      // UPDATE
      setGrid.innerHTML=''; uCondsGrid.innerHTML=''; addSetRow(); addUCondRow();
      // CREATE
      defGrid.innerHTML=''; addDefRow();
      updateOpView();
    }
    initDefaults();
    formatNow();


    // =========================
    // SQLビルダー → SQL文字列生成
    // =========================
    function buildSelectSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      // カラム
      const cols = [...colsGrid.querySelectorAll('.row input[type="text"]')]
        .map(i=>i.value.trim()).filter(Boolean);
      const colPart = cols.length? cols.join(', ') : '*';
      let sql = `SELECT ${colPart}\nFROM ${table}`;
      // JOIN（堅牢版：空行スキップ、先頭に接続詞付けない）
      const joinBlocks = [...joinsGrid.querySelectorAll('.join-block')];
      joinBlocks.forEach(block=>{
        const jt = (block.querySelector('.join-type')?.value)||'INNER JOIN';
        const jtTable = (block.querySelector('.join-table')?.value||'').trim();
        if(!jtTable) return;
        const rows = [...block.querySelectorAll('.join-cond-row')];
        const parts=[]; let first=true;
        for(const r of rows){
          const l  =(r.querySelector('.join-on-left')?.value||'').trim();
          const op =(r.querySelector('.join-on-op')?.value||'=').trim();
          const rr =(r.querySelector('.join-on-right')?.value||'').trim();
          if(!l) continue;
          let one='';
          if(op==='IS NULL' || op==='IS NOT NULL'){
            one = `${l} ${op}`;
          } else {
            if(!rr) continue;
            one = `${l} ${op} ${rr}`;
          }
          if(first){ parts.push(one); first=false; }
          else {
            const conn=(r.querySelector('.join-cond-conn')?.value||'AND').trim();
            parts.push(`${conn} ${one}`);
          }
        }
        if(parts.length){ sql += `\n${jt} ${jtTable} ON ${parts.join(' ')}`; }
      });

      // WHERE（グルーピング対応）
      const whereStr = buildWhereClause(condsGrid);
      if (whereStr === null) { alert('WHERE の括弧が未完了です。'); return ''; }
      if (whereStr) sql += `\nWHERE ${whereStr}`;

      // ORDER
      const of = ($('#b_order_field').value||'').trim();
      if(of){
        const dir = ($('#b_order_dir').value||'ASC').trim();
        sql += `\nORDER BY ${of} ${dir}`;
      }
      // LIMIT
      const lim = Number($('#b_limit').value||'');
      if(lim>0){ sql += `\nLIMIT ${lim}`; }
      return sql + ';';
    }

    function buildInsertSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      const rows = [...insGrid.querySelectorAll('.row')];
      const cols=[], vals=[];
      rows.forEach(r=>{
        const [cEl,vEl] = r.querySelectorAll('input');
        const c=(cEl?.value||'').trim();
        const v=(vEl?.value||'').trim();
        if(c && v){ cols.push(c); vals.push(v); }
      });
      if(!cols.length) return '';
      return `INSERT INTO ${table} (${cols.join(', ')})\nVALUES (${vals.join(', ')});`;
    }

    function buildUpdateSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      const setRows = [...setGrid.querySelectorAll('.row')];
      const sets = setRows.map(r=>{
        const [fEl,vEl] = r.querySelectorAll('input');
        const f=(fEl?.value||'').trim();
        const v=(vEl?.value||'').trim();
        if(!f||!v) return '';
        return `${f} = ${v}`;
      }).filter(Boolean);
      if(!sets.length) return '';
      let sql = `UPDATE ${table}\nSET ${sets.join(', ')}`;

      // UPDATE の WHERE（グルーピング対応）
      const uWhere = buildWhereClause(uCondsGrid);
      if (uWhere === null) { alert('WHERE の括弧が未完了です。'); return ''; }
      if (uWhere) sql += `\nWHERE ${uWhere}`;
      return sql + ';';
    }

    // 共通：WHERE 句を組み立て（グルーピング対応）
    // 戻り値： ''（条件なし） / 'expr ...'（成功） / null（括弧不整合）
    function buildWhereClause(container){
      const rows = [...container.querySelectorAll('.cond-row, .group-row.start, .group-row.end')];
      const parts = [];
      let opened = 0;
      let first = true;
      for (const r of rows){
        if (r.classList.contains('cond-row')){
          const f =(r.querySelector('input[type="text"]')?.value||'').trim();
          const o =(r.querySelector('.cond-op')?.value||'=').trim();
          const v =(r.querySelector('.cond-val')?.value||'').trim();
          if(!f) continue;
          let expr = '';
          if (o==='IS NULL' || o==='IS NOT NULL') expr = `${f} ${o}`;
          else if (v) expr = `${f} ${o} ${v}`;
          if(!expr) continue;
          if(first){ parts.push(expr); first=false; }
          else {
            const conn=(r.querySelector('.cond-conn')?.value||'AND').trim();
            parts.push(`${conn} ${expr}`);
          }
        } else if (r.classList.contains('group-row') && r.classList.contains('start')){
          const conn=(r.querySelector('.cond-conn')?.value||'AND').trim();
          if(first){ parts.push('('); first=false; }
          else { parts.push(`${conn} (`); }
          opened++;
        } else if (r.classList.contains('group-row') && r.classList.contains('end')){
          if (opened<=0) return null; // 閉じ過ぎ
          parts.push(')');
          opened--;
        }
      }
      if (opened!==0) return null; // 未クローズ
      return parts.join(' ');
    }

    function buildCreateSQL(){
      const table = ($('#b_table').value||'').trim();
      if(!table) return '';
      const defs = [...defGrid.querySelectorAll('.row')].map(r=>{
        const [nameEl,typeEl,nullEl,defEl,pkEl] = r.querySelectorAll('input,select');
        const name=(nameEl?.value||'').trim();
        const type=(typeEl?.value||'').trim();
        const nul =(nullEl?.value||'').trim(); // 'NOT NULL' or 'NULL'
        const defv=(defEl?.value||'').trim();
        const pk  =(pkEl?.value||'').trim();   // '' or 'PRIMARY KEY'
        if(!name||!type) return '';
        return [
          `${name} ${type}`,
          nul || '',
          defv? `DEFAULT ${defv}` : '',
          pk || ''
        ].filter(Boolean).join(' ');
      }).filter(Boolean);
      if(!defs.length) return '';
      return `CREATE TABLE ${table} (\n  ${defs.join(',\n  ')}\n);`;
    }

    // 「SQLを作る → 入力に反映」
    $('#b_make')?.addEventListener('click', ()=>{
      const op = $('#op').value;
      let sql = '';
      if(op==='select') sql = buildSelectSQL();
      else if(op==='insert') sql = buildInsertSQL();
      else if(op==='update') sql = buildUpdateSQL();
      else if(op==='create') sql = buildCreateSQL();
      if(!sql){
        alert('必要な入力が不足しています（テーブル名や項目など）');
        return;
      }
      input.value = sql;
      // 直後に整形して出力へ
      formatNow();
      // 入力欄までスクロール（任意）
      input.scrollIntoView({behavior:'smooth', block:'center'});
    });

  </script>
</body>
</html>
